name: Scheduled Tests and Maintenance

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  # Infrastructure health check
  infrastructure-health-check:
    name: Infrastructure Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: 'us-east-1'
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Python dependencies
      run: |
        pip install boto3
        
    - name: Check EC2 instances
      run: |
        cd boto3
        python list_instances.py
        
    - name: Check infrastructure status
      run: |
        cd terraform
        terraform init
        terraform plan -var="instance_count=1" -detailed-exitcode || echo "Infrastructure changes detected"
      continue-on-error: true

  # Dependency updates
  dependency-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Check frontend dependencies
      run: |
        cd frontend
        npm outdated || echo "All frontend dependencies are up to date"
      continue-on-error: true
      
    - name: Check backend dependencies
      run: |
        cd backend
        npm outdated || echo "All backend dependencies are up to date"
      continue-on-error: true

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Audit frontend dependencies
      run: |
        cd frontend
        npm audit --audit-level moderate || echo "Security vulnerabilities found in frontend"
      continue-on-error: true
      
    - name: Audit backend dependencies
      run: |
        cd backend
        npm audit --audit-level moderate || echo "Security vulnerabilities found in backend"
      continue-on-error: true 